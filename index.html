<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AR QR Code Scanner</title>
  <!-- A-Frame 和 AR.js -->
  <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
  <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/1.7.2/aframe/build/aframe-ar.min.js"></script>
  <!-- jsQR 用于扫描普通二维码 -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jsQR/1.4.0/jsQR.min.js"></script>
  <style>
    /* 隐藏用于扫描的 video 和 canvas */
    #qr-video, #qr-canvas {
      display: none;
    }
  </style>
</head>
<body style="margin: 0; overflow: hidden;">
  <!-- AR 场景 -->
  <a-scene embedded arjs="sourceType: webcam;">
    <!-- 摄像机 -->
    <a-entity camera></a-entity>
    <!-- 3D 模型，初始隐藏 -->
    <a-entity id="model" 
              position="0 1 -3" 
              scale="0.5 0.5 0.5"
              rotation="0 0 0"
              gltf-model="https://cdn.jsdelivr.net/gh/KhronosGroup/glTF-Sample-Models/2.0/Duck/glTF/Duck.gltf"
              visible="false">
    </a-entity>
  </a-scene>

  <!-- 隐藏的用于二维码扫描的视频和画布 -->
  <video id="qr-video" playsinline></video>
  <canvas id="qr-canvas"></canvas>

  <script>
    // 获取 video 与 canvas 元素
    const video = document.getElementById('qr-video');
    const canvas = document.getElementById('qr-canvas');
    const canvasContext = canvas.getContext('2d');

    let mode = 0; // 模式变量，0 表示未检测到，1 表示已检测到目标二维码

    // 请求摄像头访问（用于二维码扫描）
    navigator.mediaDevices.getUserMedia({ video: { facingMode: "environment" } })
      .then(function(stream) {
        video.srcObject = stream;
        video.play();
        requestAnimationFrame(tick);
      })
      .catch(function(err) {
        console.error("Error accessing camera: ", err);
      });

    // 每帧扫描 video 中的图像
    function tick() {
      if (video.readyState === video.HAVE_ENOUGH_DATA) {
        // 设置 canvas 尺寸与视频一致
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        // 将当前视频帧绘制到 canvas 上
        canvasContext.drawImage(video, 0, 0, canvas.width, canvas.height);
        const imageData = canvasContext.getImageData(0, 0, canvas.width, canvas.height);
        // 使用 jsQR 解析二维码
        const code = jsQR(imageData.data, canvas.width, canvas.height);
        if (code) {
          // 如果检测到二维码，且内容为 "100"
          if (code.data === "100" && mode !== 1) {
            mode = 1;
            // 显示 3D 模型
            const modelEntity = document.getElementById('model');
            modelEntity.setAttribute('visible', 'true');
            console.log("QR code detected: ", code.data);
          }
        }
      }
      requestAnimationFrame(tick);
    }

    // 让 3D 模型缓慢旋转
    const model = document.getElementById('model');
    function rotateModel() {
      if (mode === 1) {
        let rotation = model.getAttribute('rotation');
        rotation.y += 1;  // 旋转速度，可根据需要调整
        model.setAttribute('rotation', rotation);
      }
      requestAnimationFrame(rotateModel);
    }
    rotateModel();
  </script>
</body>
</html>
